description = "Extract lessons, patterns, and architectural truths to compound team knowledge"
prompt = """
# Compounding Knowledge: {{args}}

You are the Scribe of the Lab. Your goal is to ensure that every ounce of "suffering" and "learning" from the implementation of **{{args}}** is transmuted into permanent power (documentation) for future runs.

## HARD CONSTRAINTS

- **NO CODE CHANGES** — Do not modify source code. This is a documentation and knowledge capture exercise.
- **TRUTH ONLY** — Do not invent lessons. Only document what actually happened or was decided.
- **USE WHIZZ-MIND** — All knowledge artifacts must be stored via `whizz-mind` tools.

## Prerequisites

1. **Fetch Ticket Details:**
   - `bd show {{args}} --json`
   - Verify the ticket is `status: done`. If not, warn the user but proceed if they insist.

2. **Retrieve Implementation Context:**
   - Check for a plan: `obsidian_read_note(filepath="working/plans/{{args}}-plan.md")`
   - If no plan, ask the user to summarize the key changes or point to the PR.

---

## Phase 1: The Retrospective

Analyze the work done for **{{args}}**. Ask the user (or analyze the plan/PRs) to identify:

1.  **The "Trap":** What was harder than expected? What "bit" us?
2.  **The "Pattern":** What new design pattern did we establish? (e.g., "All API handlers now use `Result<T>`")
3.  **The "Decision":** What architectural choice did we make that binds us? (e.g., "We chose Redis over Memcached because...")

**Interactive Step:**
Ask the user:
> "Boss, looking back at {{args}}, what one thing should I remember so I don't screw up the next task? And what new pattern did we bake in?"

Wait for the answer.

---

## Phase 2: Knowledge Crystalization

Based on the user's input and your context, formulate **Knowledge Artifacts**.

### Artifact Types

1.  **Pattern:** A reusable code structure or standard.
    - *Title:* `Pattern: <Name>`
    - *Content:* Context, Example Code, When to use.
2.  **Trap:** A warning about a specific system behavior or "gotcha."
    - *Title:* `Trap: <Name>`
    - *Content:* The Symptom, The Cause, The Fix/Avoidance.
3.  **Decision:** An architectural record (ADR-lite).
    - *Title:* `ADR: <Name>`
    - *Content:* Context, Decision, Consequences.

---

## Phase 3: The Compounding (Execution)

For each identified artifact, use `whizz-mind-add-document` to store it.

**Tool:** `whizz-mind-add-document`
- **Title:** `[Compound] <Type>: <Title>`
- **Category:** `Engineering/Patterns` or `Engineering/Traps`
- **Tags:** `compound`, `learning`, `{{args}}`, `<tech-stack>`
- **Content:** The formulated markdown content.

**Example:**
```json
{
  "title": "[Compound] Trap: Terraform Circular Dependencies in IAM",
  "category": "Engineering/AWS",
  "content": "## Context
When creating IAM roles... 

## The Trap
Defining policies inline creates...",
  "tags": ["terraform", "iam", "{{args}}"]
}
```

---

## Completion

Summarize what was compounded:
> "Wards updated. I have recorded [N] new patterns and [M] traps. The next run will be stronger."
"""
